<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Murders - Painel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Poppins, sans-serif; background: #f0f4f8; color: #333; display: flex; min-height: 100vh; }
    
    .sidebar { width: 250px; background: #2c3e50; color: white; padding: 20px; position: fixed; height: 100vh; overflow-y: auto; }
    .sidebar h2 { margin-bottom: 30px; }
    .clan-btn { width: 100%; padding: 10px; margin: 5px 0; border: none; background: #34495e; color: white; cursor: pointer; border-radius: 4px; font-family: Poppins, sans-serif; font-weight: 600; }
    .clan-btn.active { background: #e74c3c; }
    .clan-btn:hover { background: #2980b9; }
    .sidebar hr { margin: 20px 0; border: none; border-top: 1px solid #555; }
    .tab-btn { width: 100%; padding: 10px; margin: 5px 0; border: none; background: #34495e; color: white; cursor: pointer; border-radius: 4px; font-family: Poppins, sans-serif; text-align: left; }
    .tab-btn.active { background: #3498db; font-weight: 600; }
    .tab-btn:hover { background: #2980b9; }
    
    .main { margin-left: 250px; flex: 1; padding: 20px; overflow-y: auto; }
    .header { background: white; padding: 20px; border-radius: 4px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .header h1 { font-size: 24px; color: #2c3e50; }
    
    .card { background: white; padding: 20px; border-radius: 4px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .card h3 { color: #2c3e50; margin-bottom: 8px; font-size: 16px; }
    .card p { font-size: 12px; color: #7f8c8d; margin-bottom: 15px; }
    
    .btn-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; }
    .btn { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-family: Poppins, sans-serif; font-weight: 500; transition: all 0.2s; }
    .btn-primary { background: #3498db; color: white; }
    .btn-primary:hover { background: #2980b9; transform: translateY(-1px); }
    .btn-danger { background: #e74c3c; color: white; }
    .btn-danger:hover { background: #c0392b; }
    .btn-secondary { background: #95a5a6; color: white; }
    .btn-secondary:hover { background: #7f8c8d; }
    
    .input-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; align-items: flex-end; }
    .input, select, textarea { padding: 8px 12px; border: 1px solid #bdc3c7; border-radius: 4px; font-family: Poppins, sans-serif; font-size: 12px; }
    .input { flex: 1; min-width: 150px; }
    select { flex: 0.5; min-width: 120px; }
    textarea { width: 100%; min-height: 60px; resize: vertical; }
    
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    table thead { background: #ecf0f1; position: sticky; top: 0; }
    table th, table td { padding: 10px; text-align: left; border-bottom: 1px solid #bdc3c7; }
    table th { font-weight: 600; }
    table tbody tr:hover { background: #f8f9fa; }
    table .actions { display: flex; gap: 4px; }
    
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; }
    .modal.active { display: flex; }
    .modal-content { background: white; padding: 25px; border-radius: 4px; width: 90%; max-width: 500px; max-height: 85vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-header h2 { font-size: 18px; color: #2c3e50; }
    .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #7f8c8d; }
    .form-group { margin-bottom: 12px; }
    .form-group label { display: block; font-size: 12px; margin-bottom: 4px; font-weight: 600; color: #2c3e50; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 4px; font-family: Poppins, sans-serif; font-size: 12px; }
    .modal-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
    
    .tab { display: none; }
    .tab.active { display: block; }
    
    .empty { text-align: center; color: #7f8c8d; padding: 20px; }
    
    .success { background: #d4edda; color: #155724; padding: 10px; border-radius: 4px; margin-bottom: 15px; }
    .error { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px; margin-bottom: 15px; }
    
    .checkbox-group { display: flex; gap: 8px; align-items: center; margin-bottom: 0; }
    .checkbox-group input[type="checkbox"] { cursor: pointer; width: 16px; height: 16px; }
    .checkbox-group label { margin-bottom: 0; cursor: pointer; }
    
    @media (max-width: 768px) {
      .sidebar { width: 100%; height: auto; position: relative; }
      .main { margin-left: 0; }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>‚öîÔ∏è Murders</h2>
    <button class="clan-btn active" onclick="setClan(1)" data-clan="1">Clan 1</button>
    <button class="clan-btn" onclick="setClan(2)" data-clan="2">Clan 2</button>
    <hr>
    <button class="tab-btn active" onclick="switchTab('members')" data-tab="members">üë• Membros</button>
    <button class="tab-btn" onclick="switchTab('events')" data-tab="events">üìä Presen√ßa</button>
    <button class="tab-btn" onclick="switchTab('deliveries')" data-tab="deliveries">üì¶ Entregas</button>
    <button class="tab-btn" onclick="switchTab('repo')" data-tab="repo">üìÇ Reposit√≥rio</button>
    <button class="tab-btn" onclick="switchTab('reports')" data-tab="reports">üìà Relat√≥rios</button>
  </div>

  <div class="main">
    <div class="header">
      <div>
        <h1 id="pageTitle">üë• Membros</h1>
        <p style="color: #7f8c8d; font-size: 13px;" id="pageDesc">Controle de membros</p>
      </div>
      <button class="btn btn-secondary" onclick="toggleTheme()">üåô Tema</button>
    </div>

    <!-- A√á√ïES GLOBAIS -->
    <div class="card" id="global-actions">
      <h3>Importar / Exportar dados</h3>
      <p>Use estes bot√µes para salvar ou carregar todos os dados do painel.</p>
      <div class="btn-row">
        <!-- JSON -->
        <button class="btn btn-secondary" type="button" onclick="clickImportJSON()">Importar JSON</button>
        <button class="btn btn-primary" type="button" onclick="exportJSON()">Exportar JSON</button>

        <!-- PDF -->
        <button class="btn btn-secondary" type="button" onclick="importPDF()">Importar PDF (visualiza√ß√£o)</button>
        <button class="btn btn-secondary" type="button" onclick="exportPDF()">Exportar PDF da aba atual</button>
      </div>

      <!-- input de arquivo JSON -->
      <input type="file" id="json-file-input" accept=".json,application/json" style="display:none">

      <!-- input de arquivo PDF -->
      <input type="file" id="pdf-file-input" accept="application/pdf,.pdf" style="display:none">
    </div>

    <div id="msgContainer"></div>

    <!-- WEBHOOK GLOBAL -->
    <div class="card">
      <h3>Webhook do Discord</h3>
      <div class="input-row">
        <input id="webhookUrl" class="input" placeholder="Cole a URL do webhook..." style="flex: 1;">
        <button class="btn btn-primary" onclick="saveWebhook()">‚úÖ Salvar</button>
      </div>
    </div>

    <!-- ABA MEMBROS -->
    <div class="tab active" id="tab-members">
      <div class="card">
        <h3>Membros do cl√£</h3>
        <p>Nick, level, power e classe em ordem alfab√©tica.</p>
        <div class="btn-row">
          <button class="btn btn-primary" onclick="openMemberModal()">‚ûï Novo membro</button>
          <button class="btn btn-danger" onclick="clearAllMembers()">üóëÔ∏è Apagar todos</button>
          <button class="btn btn-secondary" onclick="sendToDiscord('membros')">üí¨ Discord</button>
        </div>
        <div class="input-row">
          <input id="searchMembers" class="input" placeholder="üîç Buscar nick..." oninput="renderMembers()" style="flex: 1;">
          <select id="filterClass" onchange="renderMembers()">
            <option value="">Todas as classes</option>
            <option>Arqueira</option>
            <option>Bardo</option>
            <option>Berserker</option>
            <option>Lanceiro</option>
            <option>Maga</option>
          </select>
        </div>
        <div class="table-container">
          <table id="members-table">
            <thead>
              <tr>
                <th>Nick</th><th>Level</th><th>Power</th><th>Classe</th><th>Data</th><th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="members-body">
              <tr><td colspan="6" class="empty">Carregando...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ABA PRESEN√áA -->
    <div class="tab" id="tab-events">
      <div class="card">
        <h3>Presen√ßa em eventos</h3>
        <p>Registre m√∫ltiplos eventos por membro no mesmo dia.</p>
        <div class="btn-row">
          <button class="btn btn-primary" onclick="openEventModal()">‚ûï Novo evento</button>
          <button class="btn btn-danger" onclick="clearAllEvents()">üóëÔ∏è Apagar tudo</button>
          <button class="btn btn-secondary" onclick="sendToDiscord('presencas')">üí¨ Discord</button>
        </div>
        <div class="input-row">
          <select id="filterEvent" onchange="renderEvents()">
            <option value="">Todos eventos</option>
            <option>Boss do cl√£</option>
            <option>Copa Ymir</option>
            <option>Guerra da coroa</option>
            <option>Ilha de Sindri</option>
            <option>Interserver</option>
          </select>
          <select id="filterStatus" onchange="renderEvents()">
            <option value="">Todos status</option>
            <option>Presente</option>
            <option>Faltou</option>
            <option>Justificou</option>
          </select>
        </div>
        <div class="table-container">
          <table id="events-table">
            <thead>
              <tr>
                <th>Data</th><th>Nick</th><th>Evento</th><th>Status</th><th>Justificativa</th><th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="events-body">
              <tr><td colspan="6" class="empty">Carregando...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ABA ENTREGAS -->
    <div class="tab" id="tab-deliveries">
      <div class="card">
        <h3>Entregas do cl√£</h3>
        <p>Controle semanal e relat√≥rio mensal de entregas. Diminui automaticamente o reposit√≥rio.</p>
        <div class="btn-row">
          <button class="btn btn-primary" onclick="openDeliveryModal()">‚ûï Registrar entrega</button>
          <button class="btn btn-secondary" onclick="showMonthlyReport()">üìã Relat√≥rio mensal</button>
          <button class="btn btn-danger" onclick="clearAllDeliveries()">üóëÔ∏è Apagar tudo</button>
          <button class="btn btn-secondary" onclick="sendToDiscord('entregas')">üí¨ Discord</button>
        </div>
        <div class="input-row">
          <input id="searchDeliveriesNick" class="input" placeholder="üîç Buscar por nick..." oninput="renderDeliveries()" style="flex: 1;">
          <input id="searchDeliveriesDesc" class="input" placeholder="üîç Buscar pelo que recebeu..." oninput="renderDeliveries()" style="flex: 1;">
          <select id="filterDeliveriesClass" onchange="renderDeliveries()">
            <option value="">Todas as classes</option>
            <option>Arqueira</option>
            <option>Bardo</option>
            <option>Berserker</option>
            <option>Lanceiro</option>
            <option>Maga</option>
          </select>
        </div>
        <div class="table-container">
          <table id="deliveries-table">
            <thead>
              <tr>
                <th>Data</th><th>Nick</th><th>Classe</th><th>Descri√ß√£o da entrega</th><th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="deliveries-body">
              <tr><td colspan="5" class="empty">Carregando...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="card" id="monthly-report-card" style="margin-top:14px; display:none;">
          <div class="card-header">
            <div>
              <div class="card-title">Relat√≥rio mensal de entregas</div>
              <div class="card-sub">Resumo do que cada membro recebeu no m√™s.</div>
            </div>
          </div>
          <div class="input-row">
            <input type="month" class="input" id="reportMonth" onchange="renderMonthlyReport()" />
          </div>
          <div class="table-container">
            <table id="monthly-report-table">
              <thead>
                <tr>
                  <th>Nick</th>
                  <th>Resumo de entregas</th>
                </tr>
              </thead>
              <tbody id="monthly-report-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ABA REPOSIT√ìRIO -->
    <div class="tab" id="tab-repo">
      <div class="card">
        <h3>Itens do reposit√≥rio</h3>
        <p>Se usar o mesmo nome de item, ele s√≥ atualiza a quantidade.</p>

        <div class="card" style="margin-bottom:10px;">
          <div class="card-header">
            <div class="card-title" style="font-size:16px;">Cadastro / edi√ß√£o de itens</div>
          </div>
          <div style="padding: 15px 0;">
            <div class="form-group">
              <label for="repoItem">Item</label>
              <input id="repoItem" class="input" placeholder="Nome do item" />
            </div>
            <div class="form-group">
              <label for="repoType">Tipo</label>
              <input id="repoType" class="input" placeholder="Tipo (mat√©ria-prima, equipamento, etc.)" />
            </div>
            <div class="form-group">
              <label for="repoBoss">Boss que dropa</label>
              <input id="repoBoss" class="input" placeholder="Nome do boss" />
            </div>
            <div class="form-group">
              <label for="repoQuantity">Qtd em estoque</label>
              <input id="repoQuantity" class="input" type="number" placeholder="Quantidade atual" />
            </div>
            <div class="btn-row" style="margin-top:8px;">
              <button class="btn btn-primary" onclick="addRepoItem()">Salvar item</button>
              <button class="btn btn-danger" onclick="clearRepo()">
                Limpar reposit√≥rio
              </button>
            </div>
          </div>
        </div>

        <input id="searchRepoItem" class="input" placeholder="üîç Buscar item..." oninput="renderRepo()" style="margin-bottom: 15px;">
        
        <div class="table-container">
          <table id="repoTable">
            <thead>
              <tr>
                <th>Item</th>
                <th>Tipo</th>
                <th>Boss que dropa</th>
                <th>Qtd em estoque</th>
                <th class="text-right">A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="repoTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ABA RELAT√ìRIOS -->
    <div class="tab" id="tab-reports">
      <div class="card">
        <h3>Relat√≥rios semanais</h3>
        <p>Resumo por semana de presen√ßa e entregas.</p>
        <div class="input-row">
          <div style="flex: 1;">
            <strong>Semana de presen√ßa:</strong>
            <select id="weekPresenceSelect" class="input" onchange="renderWeeklyPresenceReport()"></select>
          </div>
          <div style="flex: 1;">
            <strong>Semana de entregas:</strong>
            <select id="weekDeliveriesSelect" class="input" onchange="renderWeeklyDeliveriesReport()"></select>
          </div>
        </div>

        <div class="card" style="margin-top:10px;">
          <div class="card-header">
            <div>
              <div class="card-title">Presen√ßa na semana</div>
              <div class="card-sub">Eventos somados por jogador.</div>
            </div>
            <button class="btn btn-secondary" onclick="copyWeeklyPresenceText()">Copiar texto</button>
          </div>
          <div id="weekly-presence-content"></div>
        </div>

        <div class="card" style="margin-top:10px;">
          <div class="card-header">
            <div>
              <div class="card-title">Entregas na semana</div>
              <div class="card-sub">Entregas somadas por jogador.</div>
            </div>
            <button class="btn btn-secondary" onclick="copyWeeklyDeliveriesText()">Copiar texto</button>
          </div>
          <div id="weekly-deliveries-content"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAIS -->
  <div class="modal" id="member-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="member-modal-title">Novo membro</h2>
        <button class="close-btn" onclick="closeMemberModal()">‚úï</button>
      </div>
      <input type="hidden" id="member-index" />
      <div class="form-group">
        <label for="member-nick">Nick</label>
        <input id="member-nick" class="input" placeholder="Nick do membro" />
      </div>
      <div class="form-group">
        <label for="member-level">Level</label>
        <input id="member-level" class="input" type="number" placeholder="Level" />
      </div>
      <div class="form-group">
        <label for="member-power">Power</label>
        <input id="member-power" class="input" type="number" placeholder="Power" />
      </div>
      <div class="form-group">
        <label for="member-class">Classe</label>
        <select id="member-class" class="input">
          <option>Arqueira</option>
          <option>Bardo</option>
          <option>Berserker</option>
          <option>Lanceiro</option>
          <option>Maga</option>
        </select>
      </div>
      <div class="form-group">
        <label for="member-date">Data (dd/mm/aaaa)</label>
        <input id="member-date" class="input" placeholder="dd/mm/aaaa" />
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeMemberModal()">Cancelar</button>
        <button class="btn btn-primary" onclick="saveMember()">Salvar</button>
      </div>
    </div>
  </div>

  <div class="modal" id="event-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="event-modal-title">Registrar presen√ßa</h2>
        <button class="close-btn" onclick="closeEventModal()">‚úï</button>
      </div>
      <input type="hidden" id="event-index" />
      <div class="form-group">
        <label for="event-date">Data (dd/mm/aaaa)</label>
        <input id="event-date" class="input" placeholder="dd/mm/aaaa" />
      </div>
      <div class="form-group">
        <label for="event-name">Evento</label>
        <select id="event-name" class="input">
          <option>Boss do cl√£</option>
          <option>Copa Ymir</option>
          <option>Guerra da coroa</option>
          <option>Ilha de Sindri</option>
          <option>Interserver</option>
        </select>
      </div>
      <div class="form-group">
        <label for="event-nick">Nick</label>
        <select id="event-nick" class="input"></select>
      </div>
      <div class="form-group">
        <label for="event-status">Status</label>
        <select id="event-status" class="input">
          <option>Presente</option>
          <option>Faltou</option>
          <option>Justificou</option>
        </select>
      </div>
      <div class="form-group">
        <label for="event-just">Justificativa (se houver)</label>
        <input id="event-just" class="input" placeholder="Justificativa" />
      </div>
      <div class="form-group">
        <div class="checkbox-group">
          <input type="checkbox" id="event-keep-same" />
          <label for="event-keep-same">Continuar adicionando eventos para este nick e data</label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeEventModal()">Cancelar</button>
        <button class="btn btn-primary" onclick="saveEvent()">Salvar</button>
      </div>
    </div>
  </div>

  <div class="modal" id="delivery-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="delivery-modal-title">Registrar entrega</h2>
        <button class="close-btn" onclick="closeDeliveryModal()">‚úï</button>
      </div>
      <input type="hidden" id="delivery-index" />
      <div class="form-group">
        <label for="delivery-date">Data (dd/mm/aaaa)</label>
        <input id="delivery-date" class="input" placeholder="dd/mm/aaaa" />
      </div>
      <div class="form-group">
        <label for="delivery-nick">Nick</label>
        <input id="delivery-nick" class="input" placeholder="Nick do membro" />
      </div>
      <div class="form-group">
        <label for="delivery-class">Classe</label>
        <select id="delivery-class" class="input">
          <option>Arqueira</option>
          <option>Bardo</option>
          <option>Berserker</option>
          <option>Lanceiro</option>
          <option>Maga</option>
        </select>
      </div>
      <div class="form-group">
        <label for="delivery-desc">Descri√ß√£o da entrega</label>
        <input id="delivery-desc" class="input" placeholder="O que foi entregue" />
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeDeliveryModal()">Cancelar</button>
        <button class="btn btn-primary" onclick="saveDelivery()">Salvar</button>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'murders_painel_v9';
    let state = {
      clan: 1,
      webhookUrl: '',
      members: { 1: [], 2: [] },
      events: { 1: [], 2: [] },
      deliveries: { 1: [], 2: [] },
      repoItems: { 1: [], 2: [] }
    };

    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        console.log('‚úÖ Salvo');
        showMessage('‚úÖ Dados salvos com sucesso!', 'success');
      } catch (e) {
        console.error('Erro ao salvar:', e);
        showMessage('‚ùå Erro ao salvar os dados', 'error');
      }
    }

    function showMessage(msg, type = 'success') {
      const container = document.getElementById('msgContainer');
      container.innerHTML = `<div class="${type}">${msg}</div>`;
      setTimeout(() => { container.innerHTML = ''; }, 3000);
    }

    function toISOFromBR(brDate) {
      if (!brDate) return '';
      const parts = brDate.split('/');
      if (parts.length !== 3) return '';
      const [d, m, y] = parts;
      return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    }

    function toBRFromISO(isoDate) {
      if (!isoDate) return '';
      const [y, m, d] = isoDate.split('-');
      if (!y || !m || !d) return '';
      return `${String(d).padStart(2,'0')}/${String(m).padStart(2,'0')}/${y}`;
    }

    function todayBR() {
      const now = new Date();
      const d = String(now.getDate()).padStart(2,'0');
      const m = String(now.getMonth()+1).padStart(2,'0');
      const y = now.getFullYear();
      return `${d}/${m}/${y}`;
    }

    function parseISO(iso) {
      if (!iso) return null;
      const [y,m,d] = iso.split('-').map(n=>parseInt(n,10));
      if (!y || !m || !d) return null;
      return new Date(y, m-1, d);
    }

    function formatDateBRFromDate(d) {
      if (!d) return '';
      const dia = String(d.getDate()).padStart(2,'0');
      const mes = String(d.getMonth()+1).padStart(2,'0');
      const ano = d.getFullYear();
      return `${dia}/${mes}/${ano}`;
    }

    function getWeekRange(date) {
      const d = new Date(date);
      d.setHours(0,0,0,0);
      const day = d.getDay();
      const sunday = new Date(d);
      sunday.setDate(d.getDate() - day);
      sunday.setHours(0,0,0,0);
      const saturday = new Date(sunday);
      saturday.setDate(sunday.getDate() + 6);
      saturday.setHours(23,59,59,999);
      return { start: sunday, end: saturday };
    }

    function weekKeyFromDate(date) {
      const range = getWeekRange(date);
      return range.start.toISOString().slice(0,10);
    }

    function setClan(clan) {
      state.clan = clan;
      document.querySelectorAll('.clan-btn').forEach(btn => {
        btn.classList.toggle('active', Number(btn.dataset.clan) === clan);
      });
      renderAll();
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
      });
      document.querySelectorAll('.tab').forEach(sec => {
        sec.classList.toggle('active', sec.id === 'tab-' + tab);
      });
      const titles = {
        members: 'üë• Membros',
        events: 'üìä Presen√ßa em eventos',
        deliveries: 'üì¶ Entregas',
        repo: 'üìÇ Reposit√≥rio',
        reports: 'üìà Relat√≥rios semanais'
      };
      const descs = {
        members: 'Controle de membros',
        events: 'Registro de presen√ßas em eventos',
        deliveries: 'Controle de entregas por membro',
        repo: 'Itens armazenados no reposit√≥rio do cl√£',
        reports: 'Resumos semanais de presen√ßa e entregas'
      };
      document.getElementById('pageTitle').textContent = titles[tab] || '';
      document.getElementById('pageDesc').textContent = descs[tab] || '';
      if (tab === 'reports') {
        buildWeekSelectors();
        renderWeeklyPresenceReport();
        renderWeeklyDeliveriesReport();
      }
    }

    function toggleTheme() {
      document.body.style.background = document.body.style.background === 'rgb(30, 30, 30)' ? '#f0f4f8' : '#1e1e1e';
      document.body.style.color = document.body.style.color === 'rgb(255, 255, 255)' ? '#333' : '#fff';
    }

    function saveWebhook() {
      state.webhookUrl = document.getElementById('webhookUrl').value.trim();
      saveState();
    }

    function sendToDiscord(tipo) {
      if (!state.webhookUrl) {
        showMessage('‚ö†Ô∏è Configure o webhook', 'error');
        return;
      }
      showMessage('üì§ Enviando ' + tipo + ' para Discord...', 'success');
    }

    // IMPORT / EXPORT JSON

    function clickImportJSON() {
      const input = document.getElementById('json-file-input');
      if (!input) {
        alert('Input de arquivo JSON n√£o encontrado.');
        return;
      }
      input.onchange = handleJSONFile;
      input.value = '';
      input.click();
    }

    function handleJSONFile(evt) {
      const file = evt.target.files && evt.target.files[0];
      if (!file) return;

      if (!file.name.toLowerCase().endsWith('.json')) {
        alert('Selecione um arquivo .json v√°lido.');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const imported = JSON.parse(e.target.result);
          if (!imported || typeof imported !== 'object') {
            alert('Arquivo JSON inv√°lido.');
            return;
          }
          if (!imported.members || !imported.events || !imported.deliveries || !imported.repoItems) {
            alert('JSON n√£o possui a estrutura esperada (members, events, deliveries, repoItems).');
            return;
          }
          state = imported;
          saveState();
          renderAll();
          alert('Dados importados com sucesso.');
        } catch (err) {
          console.error(err);
          alert('Erro ao ler o JSON: ' + err.message);
        }
      };
      reader.readAsText(file, 'utf-8');
    }

    function exportJSON() {
      try {
        const dataStr = JSON.stringify(state, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `murders-painel-${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch (err) {
        console.error(err);
        alert('Erro ao exportar JSON: ' + err.message);
      }
    }

    // IMPORT / EXPORT PDF

    function importPDF() {
      const input = document.getElementById('pdf-file-input');
      if (!input) {
        alert('Input de arquivo PDF n√£o encontrado.');
        return;
      }
      input.onchange = handlePDFFile;
      input.value = '';
      input.click();
    }

    function handlePDFFile(evt) {
      const file = evt.target.files && evt.target.files[0];
      if (!file) return;
      if (!file.name.toLowerCase().endsWith('.pdf')) {
        alert('Selecione um arquivo .pdf v√°lido.');
        return;
      }
      const url = URL.createObjectURL(file);
      window.open(url, '_blank');
    }

    function exportPDF() {
      const activeTab = document.querySelector('.tab.active');
      if (!activeTab) {
        alert('Nenhuma aba ativa encontrada.');
        return;
      }
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html>
          <head>
            <title>Murders - Export PDF</title>
            <style>
              body { font-family: Poppins, sans-serif; font-size: 12px; }
              table { width: 100%; border-collapse: collapse; }
              th, td { border: 1px solid #ccc; padding: 4px; text-align: left; }
              th { background: #f0f0f0; }
            </style>
          </head>
          <body>
            ${activeTab.innerHTML}
          </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
    }

    function openMemberModal(index = null) {
      document.getElementById('member-index').value = index || '';
      document.getElementById('member-modal-title').textContent = index !== null && index !== '' ? 'Editar membro' : 'Novo membro';
      if (index !== null && index !== '') {
        const m = state.members[state.clan][index];
        document.getElementById('member-nick').value = m.nick;
        document.getElementById('member-level').value = m.level || '';
        document.getElementById('member-power').value = m.power || '';
        document.getElementById('member-class').value = m.classe || 'Arqueira';
        document.getElementById('member-date').value = toBRFromISO(m.data) || todayBR();
      } else {
        document.getElementById('member-nick').value = '';
        document.getElementById('member-level').value = '';
        document.getElementById('member-power').value = '';
        document.getElementById('member-class').value = 'Arqueira';
        document.getElementById('member-date').value = todayBR();
      }
      openModal('member-modal');
    }

    function closeMemberModal() { closeModal('member-modal'); }

    function openModal(id) {
      document.getElementById(id).classList.add('active');
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    function saveMember() {
      const idxStr = document.getElementById('member-index').value;
      const nick = document.getElementById('member-nick').value.trim();
      if (!nick) { showMessage('‚ùå Nick √© obrigat√≥rio.', 'error'); return; }
      const dataISO = toISOFromBR(document.getElementById('member-date').value);
      const record = { 
        nick, 
        level: document.getElementById('member-level').value.trim(), 
        power: document.getElementById('member-power').value.trim(), 
        classe: document.getElementById('member-class').value, 
        data: dataISO 
      };
      const list = state.members[state.clan];
      if (idxStr !== '') {
        const idx = parseInt(idxStr,10);
        if (!Number.isNaN(idx) && list[idx]) list[idx] = record;
      } else {
        list.push(record);
      }
      saveState();
      closeMemberModal();
      renderMembers();
      fillEventNickOptions();
    }

    function deleteMember(index) {
      if (!confirm('Excluir este membro?')) return;
      state.members[state.clan].splice(index,1);
      saveState();
      renderMembers();
      fillEventNickOptions();
    }

    function renderMembers() {
      const body = document.getElementById('members-body');
      body.innerHTML = '';
      const search = (document.getElementById('searchMembers')?.value || '').toLowerCase();
      const filterClass = document.getElementById('filterClass')?.value || '';
      let list = [...(state.members[state.clan] || [])];
      if (search) list = list.filter(m => m.nick.toLowerCase().includes(search));
      if (filterClass) list = list.filter(m => m.classe === filterClass);
      list.sort((a,b)=>a.nick.localeCompare(b.nick,'pt-BR'));
      list.forEach((m,idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>
            <button class="btn btn-secondary" style="padding:3px 8px;font-size:11px;background:none;border:none;color:#3498db;text-decoration:underline;cursor:pointer;"
              onclick="openEventModal(null, '${m.nick}')">
              ${m.nick}
            </button>
          </td>
          <td>${m.level || ''}</td>
          <td>${m.power || ''}</td>
          <td>${m.classe || ''}</td>
          <td>${toBRFromISO(m.data) || ''}</td>
          <td>
            <div class="table-actions">
              <button class="btn btn-secondary" style="padding:3px 8px;font-size:11px;" onclick="openMemberModal(${idx})">Editar</button>
              <button class="btn btn-danger" style="padding:3px 8px;font-size:11px;" onclick="deleteMember(${idx})">Excluir</button>
            </div>
          </td>`;
        body.appendChild(tr);
      });
      if (!list.length) {
        const tr=document.createElement('tr');
        tr.innerHTML='<td colspan="6">Nenhum membro cadastrado.</td>';
        body.appendChild(tr);
      }
    }

    function clearAllMembers() {
      if (!confirm('Tem certeza que quer apagar TODOS os membros deste cl√£?')) return;
      state.members[state.clan] = [];
      saveState();
      renderMembers();
      fillEventNickOptions();
    }

    function fillEventNickOptions(selectedNick = '') {
      const select = document.getElementById('event-nick');
      select.innerHTML = '<option value="">-- Selecione --</option>' + 
        [...(state.members[state.clan] || [])]
        .sort((a,b) => a.nick.localeCompare(b.nick,'pt-BR'))
        .map(m => `<option value="${m.nick}" ${m.nick === selectedNick ? 'selected' : ''}>${m.nick}</option>`)
        .join('');
    }

    function openEventModal(index = null, nickFromClick = null) {
      document.getElementById('event-index').value = index || '';
      document.getElementById('event-modal-title').textContent = index !== null && index !== '' ? 'Editar presen√ßa' : 'Registrar presen√ßa';
      if (index !== null && index !== '') {
        const e = state.events[state.clan][index];
        document.getElementById('event-date').value = toBRFromISO(e.data) || todayBR();
        document.getElementById('event-name').value = e.evento;
        fillEventNickOptions(e.nick);
        document.getElementById('event-status').value = e.status;
        document.getElementById('event-just').value = e.justificativa || '';
        document.getElementById('event-keep-same').checked = false;
      } else {
        document.getElementById('event-date').value = todayBR();
        document.getElementById('event-name').value = 'Boss do cl√£';
        fillEventNickOptions(nickFromClick || '');
        document.getElementById('event-status').value = 'Presente';
        document.getElementById('event-just').value = '';
        document.getElementById('event-keep-same').checked = false;
      }
      openModal('event-modal');
    }

    function closeEventModal() { closeModal('event-modal'); }

    function saveEvent() {
      const idxStr = document.getElementById('event-index').value;
      const dataBR = document.getElementById('event-date').value.trim() || todayBR();
      const evento = document.getElementById('event-name').value;
      const nick = document.getElementById('event-nick').value.trim();
      const status = document.getElementById('event-status').value;
      const justificativa = document.getElementById('event-just').value.trim();
      if (!nick) { showMessage('‚ùå Nick √© obrigat√≥rio.', 'error'); return; }
      const dataISO = toISOFromBR(dataBR);
      const record = { data: dataISO, evento, nick, status, justificativa };
      const list = state.events[state.clan];
      if (idxStr !== '') {
        const idx = parseInt(idxStr,10);
        if (!Number.isNaN(idx) && list[idx]) list[idx] = record;
      } else {
        list.push(record);
      }
      saveState();
      renderEvents();
      if (document.getElementById('event-keep-same').checked) {
        document.getElementById('event-name').value = 'Boss do cl√£';
        document.getElementById('event-status').value = 'Presente';
        document.getElementById('event-just').value = '';
        document.getElementById('event-index').value = '';
        showMessage('‚úÖ Evento salvo! Continue adicionando...', 'success');
      } else {
        closeEventModal();
        showMessage('‚úÖ Evento salvo!', 'success');
      }
    }

    function deleteEvent(index) {
      if (!confirm('Excluir este registro de presen√ßa?')) return;
      state.events[state.clan].splice(index,1);
      saveState();
      renderEvents();
      buildWeekSelectors();
    }

    function renderEvents() {
      const body = document.getElementById('events-body');
      const filterEvent = document.getElementById('filterEvent')?.value || '';
      const filterStatus = document.getElementById('filterStatus')?.value || '';
      let list = [...(state.events[state.clan] || [])];
      if (filterEvent) list = list.filter(e=>e.evento===filterEvent);
      if (filterStatus) list = list.filter(e=>e.status===filterStatus);
      list.sort((a,b)=>(a.data || '').localeCompare(b.data || '') || a.nick.localeCompare(b.nick,'pt-BR'));
      body.innerHTML = '';
      list.forEach((e,idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${toBRFromISO(e.data)}</td>
          <td><strong>${e.nick}</strong></td>
          <td>${e.evento}</td>
          <td><strong style="color: ${e.status === 'Presente' ? '#27ae60' : e.status === 'Faltou' ? '#e74c3c' : '#f39c12'}">${e.status}</strong></td>
          <td>${e.justificativa || '-'}</td>
          <td>
            <div class="table-actions">
              <button class="btn btn-secondary" style="padding:3px 8px;font-size:11px;" onclick="openEventModal(${idx})">Ver / editar</button>
              <button class="btn btn-danger" style="padding:3px 8px;font-size:11px;" onclick="deleteEvent(${idx})">Excluir</button>
            </div>
          </td>`;
        body.appendChild(tr);
      });
      if (!list.length) {
        const tr=document.createElement('tr');
        tr.innerHTML='<td colspan="6">Nenhuma presen√ßa registrada com esses filtros.</td>';
        body.appendChild(tr);
      }
      buildWeekSelectors();
    }

    function clearAllEvents() {
      if (!confirm('Tem certeza que quer apagar TODAS as presen√ßas deste cl√£?')) return;
      state.events[state.clan] = [];
      saveState();
      renderEvents();
      buildWeekSelectors();
    }

    function openDeliveryModal(index = null) {
      document.getElementById('delivery-index').value = index || '';
      document.getElementById('delivery-modal-title').textContent = index !== null && index !== '' ? 'Editar entrega' : 'Registrar entrega';
      if (index !== null && index !== '') {
        const d = state.deliveries[state.clan][index];
        document.getElementById('delivery-date').value = toBRFromISO(d.data) || todayBR();
        document.getElementById('delivery-nick').value = d.nick;
        document.getElementById('delivery-class').value = d.classe;
        document.getElementById('delivery-desc').value = d.descricao || '';
      } else {
        document.getElementById('delivery-date').value = todayBR();
        document.getElementById('delivery-nick').value = '';
        document.getElementById('delivery-class').value = 'Arqueira';
        document.getElementById('delivery-desc').value = '';
      }
      openModal('delivery-modal');
    }

    function closeDeliveryModal() { closeModal('delivery-modal'); }

    function saveDelivery() {
      const idxStr = document.getElementById('delivery-index').value;
      const dataBR = document.getElementById('delivery-date').value.trim() || todayBR();
      const nick = document.getElementById('delivery-nick').value.trim();
      const classe = document.getElementById('delivery-class').value;
      const descricao = document.getElementById('delivery-desc').value.trim();
      if (!nick || !descricao) { showMessage('‚ùå Nick e descri√ß√£o s√£o obrigat√≥rios.', 'error'); return; }
      const dataISO = toISOFromBR(dataBR);
      const record = { data: dataISO, nick, classe, descricao };
      const list = state.deliveries[state.clan];
      if (idxStr!=='') {
        const idx = parseInt(idxStr,10);
        if (!Number.isNaN(idx) && list[idx]) list[idx]=record;
      } else {
        list.push(record);
        const repo = state.repoItems[state.clan] || [];
        const match = descricao.match(/(\d+)/);
        const qtd = match ? parseInt(match[1]) : 1;
        const found = repo.find(r => descricao.toLowerCase().includes((r.item || '').toLowerCase()));
        if (found) {
          found.qtd = Math.max(0, Number(found.qtd || 0) - qtd);
        }
      }
      saveState();
      closeDeliveryModal();
      renderDeliveries();
      renderRepo();
    }

    function deleteDelivery(index) {
      if (!confirm('Excluir esta entrega?')) return;
      state.deliveries[state.clan].splice(index,1);
      saveState();
      renderDeliveries();
      buildWeekSelectors();
    }

    function renderDeliveries() {
      const body = document.getElementById('deliveries-body');
      const searchNick = (document.getElementById('searchDeliveriesNick')?.value || '').toLowerCase();
      const searchDesc = (document.getElementById('searchDeliveriesDesc')?.value || '').toLowerCase();
      const filterClass = document.getElementById('filterDeliveriesClass')?.value || '';
      let list = [...(state.deliveries[state.clan] || [])];
      if (searchNick) list = list.filter(d=>d.nick.toLowerCase().includes(searchNick));
      if (searchDesc) list = list.filter(d=>(d.descricao || '').toLowerCase().includes(searchDesc));
      if (filterClass) list = list.filter(d=>d.classe===filterClass);
      list.sort((a,b)=>a.nick.localeCompare(b.nick,'pt-BR'));
      body.innerHTML = '';
      list.forEach((d,idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${toBRFromISO(d.data)}</td>
          <td>${d.nick}</td>
          <td>${d.classe}</td>
          <td>${d.descricao || ''}</td>
          <td>
            <div class="table-actions">
              <button class="btn btn-secondary" style="padding:3px 8px;font-size:11px;" onclick="openDeliveryModal(${idx})">Editar</button>
              <button class="btn btn-danger" style="padding:3px 8px;font-size:11px;" onclick="deleteDelivery(${idx})">Excluir</button>
            </div>
          </td>`;
        body.appendChild(tr);
      });
      if (!list.length) {
        const tr=document.createElement('tr');
        tr.innerHTML='<td colspan="5">Nenhuma entrega registrada.</td>';
        body.appendChild(tr);
      }
      buildWeekSelectors();
    }

    function clearAllDeliveries() {
      if (!confirm('Tem certeza que quer apagar TODAS as entregas deste cl√£?')) return;
      state.deliveries[state.clan] = [];
      saveState();
      renderDeliveries();
    }

    function showMonthlyReport() {
      document.getElementById('monthly-report-card').style.display='block';
      if (!document.getElementById('reportMonth').value) {
        const now=new Date();
        const ym=now.toISOString().slice(0,7);
        document.getElementById('reportMonth').value=ym;
      }
      renderMonthlyReport();
    }

    function renderMonthlyReport() {
      const monthInput=document.getElementById('reportMonth').value;
      const body=document.getElementById('monthly-report-body');
      if (!monthInput) return;
      body.innerHTML='';
      const [year,month]=monthInput.split('-');
      const list=(state.deliveries[state.clan] || []).filter(d=>d.data && d.data.startsWith(year+'-'+month));
      const byNick={};
      list.forEach(d=>{
        if(!byNick[d.nick]) byNick[d.nick]=[];
        byNick[d.nick].push(d.descricao||'(sem descri√ß√£o)');
      });
      const nicks=Object.keys(byNick).sort((a,b)=>a.localeCompare(b,'pt-BR'));
      nicks.forEach(nick=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${nick}</td><td>${byNick[nick].join(' ‚Ä¢ ')}</td>`;
        body.appendChild(tr);
      });
      if (!nicks.length) {
        const tr=document.createElement('tr');
        tr.innerHTML='<td colspan="2">Nenhuma entrega neste m√™s.</td>';
        body.appendChild(tr);
      }
    }

    function renderRepo() {
      const tbody = document.getElementById('repoTableBody');
      const search = (document.getElementById('searchRepoItem')?.value || '').toLowerCase();
      let list = state.repoItems[state.clan] || [];
      if (search) list = list.filter(r => (r.item || '').toLowerCase().includes(search) || (r.tipo || '').toLowerCase().includes(search));
      tbody.innerHTML = '';
      list.forEach((r, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.item}</td>
          <td>${r.tipo || ''}</td>
          <td>${r.boss || ''}</td>
          <td>${r.qtd != null ? r.qtd : ''}</td>
          <td class="text-right">
            <button class="btn btn-danger" style="padding:3px 8px;font-size:11px;"
              onclick="deleteRepoItem(${index})">
              Excluir
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      if (!list.length) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="5">Nenhum item no reposit√≥rio.</td>`;
        tbody.appendChild(tr);
      }
    }

    function addRepoItem() {
      const itemNome = document.getElementById('repoItem').value.trim();
      const tipo = document.getElementById('repoType').value.trim();
      const boss = document.getElementById('repoBoss').value.trim();
      const qtdStr = document.getElementById('repoQuantity').value.trim();
      if (!itemNome) { showMessage('‚ùå Informe o nome do item.', 'error'); return; }
      const qtdNum = qtdStr === '' ? 0 : parseInt(qtdStr, 10);
      const list = state.repoItems[state.clan] || (state.repoItems[state.clan] = []);
      const idx = list.findIndex(r => r.item.toLowerCase() === itemNome.toLowerCase());
      if (idx >= 0) {
        list[idx].tipo = tipo;
        list[idx].boss = boss;
        list[idx].qtd = qtdNum;
      } else {
        list.push({ item: itemNome, tipo, boss, qtd: qtdNum });
      }
      document.getElementById('repoItem').value = '';
      document.getElementById('repoType').value = '';
      document.getElementById('repoBoss').value = '';
      document.getElementById('repoQuantity').value = '';
      saveState();
      renderRepo();
    }

    function clearRepo() {
      if (!confirm('Tem certeza que quer limpar todo o reposit√≥rio deste cl√£?')) return;
      state.repoItems[state.clan] = [];
      saveState();
      renderRepo();
    }

    function deleteRepoItem(index) {
      const list = state.repoItems[state.clan] || [];
      if (!list[index]) return;
      if (!confirm(`Remover o item "${list[index].item}" do reposit√≥rio?`)) return;
      list.splice(index, 1);
      saveState();
      renderRepo();
    }

    function buildWeekSelectors(){
      const presenceSelect=document.getElementById('weekPresenceSelect');
      const deliveriesSelect=document.getElementById('weekDeliveriesSelect');
      if(!presenceSelect||!deliveriesSelect)return;
      const events=state.events[state.clan] || [];
      const presMap={};
      events.forEach(e=>{
        const d=parseISO(e.data);
        if(!d)return;
        const key=weekKeyFromDate(d);
        if(!presMap[key]){
          const range=getWeekRange(d);
          presMap[key]={start:range.start,end:range.end};
        }
      });
      const presWeeks=Object.keys(presMap).map(k=>({key:k,start:presMap[k].start,end:presMap[k].end})).sort((a,b)=>a.start-b.start);
      presenceSelect.innerHTML='';
      presWeeks.forEach(w=>{
        const opt=document.createElement('option');
        opt.value=w.key;
        opt.textContent=`${w.key} (${formatDateBRFromDate(w.start)} - ${formatDateBRFromDate(w.end)})`;
        presenceSelect.appendChild(opt);
      });
      const delivs=state.deliveries[state.clan] || [];
      const delMap={};
      delivs.forEach(d=>{
        const dt=parseISO(d.data);
        if(!dt)return;
        const key=weekKeyFromDate(dt);
        if(!delMap[key]){
          const range=getWeekRange(dt);
          delMap[key]={start:range.start,end:range.end};
        }
      });
      const delWeeks=Object.keys(delMap).map(k=>({key:k,start:delMap[k].start,end:delMap[k].end})).sort((a,b)=>a.start-b.start);
      deliveriesSelect.innerHTML='';
      delWeeks.forEach(w=>{
        const opt=document.createElement('option');
        opt.value=w.key;
        opt.textContent=`${w.key} (${formatDateBRFromDate(w.start)} - ${formatDateBRFromDate(w.end)})`;
        deliveriesSelect.appendChild(opt);
      });
      if(presWeeks.length && !presenceSelect.value) presenceSelect.value=presWeeks[presWeeks.length-1].key;
      if(delWeeks.length && !deliveriesSelect.value) deliveriesSelect.value=delWeeks[delWeeks.length-1].key;
    }

    function renderWeeklyPresenceReport(){
      const sel=document.getElementById('weekPresenceSelect');
      const container=document.getElementById('weekly-presence-content');
      if (!container) return;
      container.innerHTML='';
      if(!sel || !sel.value){
        container.innerHTML='<div class="empty">Nenhuma semana dispon√≠vel.</div>';
        return;
      }
      const events=state.events[state.clan] || [];
      const refDate=parseISO(sel.value);
      if(!refDate)return;
      const range=getWeekRange(refDate);
      const filtered=events.filter(e=>{
        const d=parseISO(e.data);
        if(!d)return false;
        return d>=range.start && d<=range.end;
      });
      if(!filtered.length){
        container.innerHTML='<div class="empty">Sem registros de presen√ßa nessa semana.</div>';
        return;
      }
      const members={};
      filtered.forEach(e=>{
        const nick=e.nick;
        if(!members[nick]) members[nick]={dates:{}};
        const d=parseISO(e.data);
        const dKey=formatDateBRFromDate(d);
        if(!members[nick].dates[dKey]) members[nick].dates[dKey]={presentes:[],faltas:[],justificadas:[]};
        const bucket=members[nick].dates[dKey];
        if(e.status==='Presente') bucket.presentes.push(e.evento);
        else if(e.status==='Faltou') bucket.faltas.push(e.evento);
        else if(e.status==='Justificou') bucket.justificadas.push(e.evento);
      });
      const entries=Object.keys(members).sort((a,b)=>a.localeCompare(b,'pt-BR')).map(name=>{
        const dates=Object.keys(members[name].dates).sort((a,b)=>{
          const pa=a.split('/').reverse().join('-');
          const pb=b.split('/').reverse().join('-');
          return pa.localeCompare(pb);
        }).map(ds=>{
          const info=members[name].dates[ds];
          return {dateStr:ds, presentes:info.presentes, faltas:info.faltas, justificadas:info.justificadas};
        });
        return {name,dates};
      });
      entries.forEach(m=>{
        const div=document.createElement('div');
        div.className='history-member';
        const h=document.createElement('h4');
        h.textContent=m.name;
        div.appendChild(h);
        const dates=document.createElement('div');
        dates.className='history-dates';
        m.dates.forEach(d=>{
          const pres=d.presentes.length?`Foi em: ${d.presentes.join(', ')}`:'';
          const falt=d.faltas.length?`Faltou em: ${d.faltas.join(', ')}`:'';
          const jus=d.justificadas.length?`Justificou: ${d.justificadas.join(', ')}`:'';
          const parts=[pres,falt,jus].filter(Boolean).join(' | ');
          const p=document.createElement('div');
          p.textContent=`${d.dateStr}: ${parts}`;
          dates.appendChild(p);
        });
        div.appendChild(dates);
        container.appendChild(div);
      });
    }

    function renderWeeklyDeliveriesReport(){
      const sel=document.getElementById('weekDeliveriesSelect');
      const container=document.getElementById('weekly-deliveries-content');
      if (!container) return;
      container.innerHTML='';
      if(!sel || !sel.value){
        container.innerHTML='<div class="empty">Nenhuma semana dispon√≠vel.</div>';
        return;
      }
      const delivs=state.deliveries[state.clan] || [];
      const refDate=parseISO(sel.value);
      if(!refDate)return;
      const range=getWeekRange(refDate);
      const filtered=delivs.filter(d=>{
        const dt=parseISO(d.data);
        if(!dt) return false;
        return dt>=range.start && dt<=range.end;
      });
      if(!filtered.length){
        container.innerHTML='<div class="empty">Sem entregas nessa semana.</div>';
        return;
      }
      const members={};
      filtered.forEach(d=>{
        const nick=d.nick;
        const dt=parseISO(d.data);
        if(!members[nick]) members[nick]={dates:{}};
        const dKey=formatDateBRFromDate(dt);
        if(!members[nick].dates[dKey]) members[nick].dates[dKey]=[];
        members[nick].dates[dKey].push(d.descricao || '(sem descri√ß√£o)');
      });
      const entries=Object.keys(members).sort((a,b)=>a.localeCompare(b,'pt-BR')).map(name=>{
        const dates=Object.keys(members[name].dates).sort((a,b)=>{
          const pa=a.split('/').reverse().join('-');
          const pb=b.split('/').reverse().join('-');
          return pa.localeCompare(pb);
        }).map(ds=>({dateStr:ds,entregas:members[name].dates[ds]}));
        return {name,dates};
      });
      entries.forEach(m=>{
        const div=document.createElement('div');
        div.className='history-member';
        const h=document.createElement('h4');
        h.textContent=m.name;
        div.appendChild(h);
        const dates=document.createElement('div');
        dates.className='history-dates';
        m.dates.forEach(d=>{
          const p=document.createElement('div');
          p.textContent=`${d.dateStr}: ${d.entregas.join(' | ')}`;
          dates.appendChild(p);
        });
        div.appendChild(dates);
        container.appendChild(div);
      });
    }

    function copyWeeklyPresenceText(){
      const container=document.getElementById('weekly-presence-content');
      if (!container) return;
      const text=container.innerText || container.textContent || '';
      if (!text.trim()) { showMessage('Nada para copiar.', 'error'); return; }
      navigator.clipboard.writeText(text).then(()=>{
        showMessage('Relat√≥rio de presen√ßa copiado!', 'success');
      }).catch(()=>{
        showMessage('Erro ao copiar.', 'error');
      });
    }

    function copyWeeklyDeliveriesText(){
      const container=document.getElementById('weekly-deliveries-content');
      if (!container) return;
      const text=container.innerText || container.textContent || '';
      if (!text.trim()) { showMessage('Nada para copiar.', 'error'); return; }
      navigator.clipboard.writeText(text).then(()=>{
        showMessage('Relat√≥rio de entregas copiado!', 'success');
      }).catch(()=>{
        showMessage('Erro ao copiar.', 'error');
      });
    }

    function renderAll() {
      document.getElementById('webhookUrl').value = state.webhookUrl || '';
      renderMembers();
      renderEvents();
      renderDeliveries();
      renderRepo();
      buildWeekSelectors();
      renderWeeklyPresenceReport();
      renderWeeklyDeliveriesReport();
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          state = JSON.parse(raw);
          console.log('‚úÖ Estado carregado');
        }
      } catch (e) {
        console.error('Erro ao carregar:', e);
      }
      renderAll();
    }

    window.addEventListener('load', loadState);
  </script>
</body>
</html>
